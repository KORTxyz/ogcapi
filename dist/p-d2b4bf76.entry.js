import{r as t,c as e,h as n,H as i,g as r}from"./p-597d4401.js";import{c as s}from"./p-3e8ff66b.js";var o=s((function(t,e){Object.defineProperty(e,"__esModule",{value:!0});const n=new WeakMap,i=new WeakMap;function r(t){const e=n.get(t);return console.assert(null!=e,"'this' is expected an Event object, but got",t),e}function s(t,e){n.set(this,{eventTarget:t,event:e,eventPhase:2,currentTarget:t,canceled:!1,stopped:!1,passiveListener:null,timeStamp:e.timeStamp||Date.now()}),Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});const i=Object.keys(e);for(let t=0;t<i.length;++t){const e=i[t];e in this||Object.defineProperty(this,e,o(e))}}function o(t){return{get(){return r(this).event[t]},set(e){r(this).event[t]=e},configurable:!0,enumerable:!0}}function u(t){return{value(){const e=r(this).event;return e[t].apply(e,arguments)},configurable:!0,enumerable:!0}}function l(t){if(null==t||t===Object.prototype)return s;let e=i.get(t);return null==e&&(e=function(t,e){const n=Object.keys(e);if(0===n.length)return t;function i(e,n){t.call(this,e,n)}i.prototype=Object.create(t.prototype,{constructor:{value:i,configurable:!0,writable:!0}});for(let r=0;r<n.length;++r){const s=n[r];if(!(s in t.prototype)){const t=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(i.prototype,s,"function"==typeof t.value?u(s):o(s))}}return i}(l(Object.getPrototypeOf(t)),t),i.set(t,e)),e}function h(t){return r(t).stopped}function a(t,e){r(t).passiveListener=e}s.prototype={get type(){return r(this).event.type},get target(){return r(this).eventTarget},get currentTarget(){return r(this).currentTarget},composedPath(){const t=r(this).currentTarget;return null==t?[]:[t]},get NONE(){return 0},get CAPTURING_PHASE(){return 1},get AT_TARGET(){return 2},get BUBBLING_PHASE(){return 3},get eventPhase(){return r(this).eventPhase},stopPropagation(){const t=r(this);"function"==typeof t.event.stopPropagation&&t.event.stopPropagation()},stopImmediatePropagation(){const t=r(this);t.stopped=!0,"function"==typeof t.event.stopImmediatePropagation&&t.event.stopImmediatePropagation()},get bubbles(){return Boolean(r(this).event.bubbles)},get cancelable(){return Boolean(r(this).event.cancelable)},preventDefault(){const t=r(this);null==t.passiveListener?t.event.cancelable&&(t.canceled=!0,"function"==typeof t.event.preventDefault&&t.event.preventDefault()):console.warn("Event#preventDefault() was called from a passive listener:",t.passiveListener)},get defaultPrevented(){return r(this).canceled},get composed(){return Boolean(r(this).event.composed)},get timeStamp(){return r(this).timeStamp}},Object.defineProperty(s.prototype,"constructor",{value:s,configurable:!0,writable:!0}),"undefined"!=typeof window&&void 0!==window.Event&&(Object.setPrototypeOf(s.prototype,window.Event.prototype),i.set(window.Event.prototype,s));const c=new WeakMap;function f(t){return null!==t&&"object"==typeof t}function p(t){const e=c.get(t);if(null==e)throw new TypeError("'this' is expected an EventTarget object, but got another value.");return e}function d(t,e){Object.defineProperty(t,"on"+e,function(t){return{get(){let e=p(this).get(t);for(;null!=e;){if(3===e.listenerType)return e.listener;e=e.next}return null},set(e){"function"==typeof e||f(e)||(e=null);const n=p(this);let i=null,r=n.get(t);for(;null!=r;)3===r.listenerType?null!==i?i.next=r.next:null!==r.next?n.set(t,r.next):n.delete(t):i=r,r=r.next;if(null!==e){const r={listener:e,listenerType:3,passive:!1,once:!1,next:null};null===i?n.set(t,r):i.next=r}},configurable:!0,enumerable:!0}}(e))}function b(t){function e(){w.call(this)}e.prototype=Object.create(w.prototype,{constructor:{value:e,configurable:!0,writable:!0}});for(let n=0;n<t.length;++n)d(e.prototype,t[n]);return e}function w(){if(!(this instanceof w)){if(1===arguments.length&&Array.isArray(arguments[0]))return b(arguments[0]);if(arguments.length>0){const t=new Array(arguments.length);for(let e=0;e<arguments.length;++e)t[e]=arguments[e];return b(t)}throw new TypeError("Cannot call a class as a function")}c.set(this,new Map)}w.prototype={addEventListener(t,e,n){if(null==e)return!1;if("function"!=typeof e&&!f(e))throw new TypeError("'listener' should be a function or an object.");const i=p(this),r=f(n),s=(r?Boolean(n.capture):Boolean(n))?1:2,o={listener:e,listenerType:s,passive:r&&Boolean(n.passive),once:r&&Boolean(n.once),next:null};let u=i.get(t);if(void 0===u)return i.set(t,o),!0;let l=null;for(;null!=u;){if(u.listener===e&&u.listenerType===s)return!1;l=u,u=u.next}return l.next=o,!0},removeEventListener(t,e,n){if(null==e)return!1;const i=p(this),r=(f(n)?Boolean(n.capture):Boolean(n))?1:2;let s=null,o=i.get(t);for(;null!=o;){if(o.listener===e&&o.listenerType===r)return null!==s?s.next=o.next:null!==o.next?i.set(t,o.next):i.delete(t),!0;s=o,o=o.next}return!1},dispatchEvent(t){if(null==t||"string"!=typeof t.type)throw new TypeError('"event.type" should be a string.');const e=p(this),n=t.type;let i=e.get(n);if(null==i)return!0;const s=function(t,e){return new(l(Object.getPrototypeOf(e)))(t,e)}(this,t);let o=null;for(;null!=i;){if(i.once?null!==o?o.next=i.next:null!==i.next?e.set(n,i.next):e.delete(n):o=i,a(s,i.passive?i.listener:null),"function"==typeof i.listener)try{i.listener.call(this,s)}catch(t){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(t)}else 3!==i.listenerType&&"function"==typeof i.listener.handleEvent&&i.listener.handleEvent(s);if(h(s))break;i=i.next}return a(s,null),function(t){r(t).eventPhase=0}(s),function(t){r(t).currentTarget=null}(s),!s.defaultPrevented}},Object.defineProperty(w.prototype,"constructor",{value:w,configurable:!0,writable:!0}),"undefined"!=typeof window&&void 0!==window.EventTarget&&Object.setPrototypeOf(w.prototype,window.EventTarget.prototype),e.defineEventAttribute=d,e.EventTarget=w,e.default=w,t.exports=w,t.exports.EventTarget=t.exports.default=w,t.exports.defineEventAttribute=d}));class u{constructor(t){this.endpoint=t.endpoint,this.file=t.file,this.headers=t.headers||{},this.postParams=t.postParams,this.chunkSize=t.chunkSize||10,this.retries=t.retries||5,this.delayBeforeRetry=t.delayBeforeRetry||5,this.start=0,this.chunk=null,this.chunkCount=0,this.totalChunks=Math.ceil(this.file.size/(1e3*this.chunkSize*1e3)),this.retriesCount=0,this.offline=!1,this.paused=!1,this.headers["uploader-file-id"]=this._uniqid(this.file),this.headers["uploader-chunks-total"]=this.totalChunks,this._reader=new FileReader,this._eventTarget=new o.EventTarget,this._validateParams(),this._sendChunks(),window.addEventListener("online",(()=>{this.offline&&(this.offline=!1,this._eventTarget.dispatchEvent(new Event("online")),this._sendChunks())})),window.addEventListener("offline",(()=>{this.offline=!0,this._eventTarget.dispatchEvent(new Event("offline"))}))}on(t,e){this._eventTarget.addEventListener(t,e)}_validateParams(){if(!this.endpoint||!this.endpoint.length)throw new TypeError("endpoint must be defined");if(this.file instanceof File==0)throw new TypeError("file must be a File object");if(this.headers&&"object"!=typeof this.headers)throw new TypeError("headers must be null or an object");if(this.postParams&&"object"!=typeof this.postParams)throw new TypeError("postParams must be null or an object");if(this.chunkSize&&("number"!=typeof this.chunkSize||0===this.chunkSize))throw new TypeError("chunkSize must be a positive number");if(this.retries&&("number"!=typeof this.retries||0===this.retries))throw new TypeError("retries must be a positive number");if(this.delayBeforeRetry&&"number"!=typeof this.delayBeforeRetry)throw new TypeError("delayBeforeRetry must be a positive number")}_uniqid(){return Math.floor(1e8*Math.random())+Date.now()+this.file.size}_getChunk(){return new Promise((t=>{const e=1===this.totalChunks?this.file.size:1e3*this.chunkSize*1e3,n=e*this.chunkCount;this._reader.onload=()=>{this.chunk=new Blob([this._reader.result],{type:"application/octet-stream"}),t()},this._reader.readAsArrayBuffer(this.file.slice(n,n+e))}))}_sendChunk(){const t=new FormData;return this.chunkCount+1===this.totalChunks&&this.postParams&&Object.keys(this.postParams).forEach((e=>t.append(e,this.postParams[e]))),t.append("file",this.chunk),this.headers["uploader-chunk-number"]=this.chunkCount,fetch(this.endpoint,{method:"POST",headers:this.headers,body:t})}_manageRetries(){if(this.retriesCount++<this.retries)return setTimeout((()=>this._sendChunks()),1e3*this.delayBeforeRetry),void this._eventTarget.dispatchEvent(new CustomEvent("fileRetry",{detail:{message:`An error occured uploading chunk ${this.chunkCount}. ${this.retries-this.retriesCount} retries left`,chunk:this.chunkCount,retriesLeft:this.retries-this.retriesCount}}));this._eventTarget.dispatchEvent(new CustomEvent("error",{detail:`An error occured uploading chunk ${this.chunkCount}. No more retries, stopping upload`}))}_sendChunks(){this.paused||this.offline||this._getChunk().then((()=>this._sendChunk())).then((t=>{if(200===t.status||201===t.status||204===t.status){++this.chunkCount<this.totalChunks?this._sendChunks():this._eventTarget.dispatchEvent(new Event("finish"));const t=Math.round(100/this.totalChunks*this.chunkCount);this._eventTarget.dispatchEvent(new CustomEvent("progress",{detail:t}))}else if([408,502,503,504].includes(t.status)){if(this.paused||this.offline)return;this._manageRetries()}else{if(this.paused||this.offline)return;this._eventTarget.dispatchEvent(new CustomEvent("error",{detail:`Server responded with ${t.status}. Stopping upload`}))}})).catch((()=>{this.paused||this.offline||this._manageRetries()}))}togglePause(){this.paused=!this.paused,this.paused||this._sendChunks()}}const l=class{constructor(n){t(this,n),this.uploadStatus=e(this,"uploadStatus",7),this.text="Upload"}upload(t){t.target.files.length>0&&[...t.target.files].forEach((t=>{const e=new u({endpoint:"https://kort.xyz/collections",file:t,postParams:{name:t.name,group:"uploads"}});e.on("error",(t=>this.uploadStatus.emit({code:"error",value:t.detail}))),e.on("progress",(e=>{document.querySelector("kortxyz-notifications").update({name:"uploader_"+t,icon:"backup",text:t.name+" at "+e.detail+"%"})})),e.on("finish",(()=>{document.querySelector("kortxyz-notifications").add({name:"uploader_"+t,icon:"backup",text:t.name+" uploaded"})}))}))}render(){return n(i,{onClick:()=>this.inputEl.click()},n("input",{ref:t=>this.inputEl=t,type:"file",onChange:t=>this.upload(t),multiple:!0}))}get dropzoneEl(){return r(this)}};l.style="kortxyz-uploader{height:100%;flex:1}kortxyz-uploader>input{visibility:hidden;position:absolute;left:0;width:100%}";export{l as kortxyz_uploader}